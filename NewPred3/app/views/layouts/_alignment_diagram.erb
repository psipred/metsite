<%  length = seq.length() 
  hostname = self.request.host
  @annotation_copy = @job_results%>

<script>
  $(document).ready(function() {

    <% if gen_control == 0
      name="gen" %>
      $( "#gen_model_button, #gen_model_button2" ).click(function() {
        $("input[name='gen_selector']:radio").each(function(){
        
    <% elsif gen_control == 1
      name="mgen" %>
      $( "#mgen_model_button, #mgen_model_button2" ).click(function() {
        $("input[name='mgen_selector']:radio").each(function(){
    <% elsif gen_control == 2
      name="dgen" %>
      $( "#dgen_model_button, #dgen_model_button2" ).click(function() {
        $("input[name='dgen_selector']:radio").each(function(){
    <% end %>
        if($(this).is(':checked'))
        {
        // Iterate through all checked radio buttons
        var url = $(this).val();
        var pdb = $(this).attr("id");
        var chain = pdb.substring(4,5)
        <% if gen_control == 0 || gen_control == 1 %>
            var type = 0
        <% else %>
           var type = 1
        <% end %>
        var subject= "<%= @job.name %>"
        if(type == 0)
        {
          pdb = pdb.substring(0, 4)
        }

        var oRequest;
        // Mozilla-based browsers
        if (window.XMLHttpRequest) {
          oRequest = new XMLHttpRequest();
        } else if (window.ActiveXObject) {
          oRequest = new ActiveXObject("Msxml2.XMLHTTP");
          if (!oRequest) {
            oRequest = new ActiveXObject("Microsoft.XMLHTTP");
          }
        }

        oRequest.open("GET",url,false);
        oRequest.setRequestHeader("User-Agent",navigator.userAgent);
        oRequest.send(null)

        alignment = "";
        if (oRequest.status==200)
        {
          alignment = oRequest.responseText;
          var lines=alignment.split("\n");
		  var new_aln = ">P1%3B"+pdb+"%0Astructure:"+pdb+"::"+chain+"::"+chain+"::::%0A"+lines[1]+"*%0A";
          new_aln = new_aln + ">P1%3b"+subject+"%0Asequence:"+subject+"::::::::%0A"+lines[3]+"*%0A";
          //alert(new_aln);

          window.open("http://<%= hostname %>/simple_modeller/submit/?"+
                                          "name="+pdb+
                                          "&pdb_type="+ type+
                                          "&mod=1&template="+pdb+
                                          "&alignment="+new_aln
                                        );
        }
        else
        {
          alert("Error executing alignment Request call!");
        }
        
      }
      });
    });

  });
</script>

<div class="span12">

    <div class="span13">
      <% name = ""
      numberofrows = results.data.split(/\n/).length
    if gen_control == 0
      name="gen" %>
      <table>
        <tr><td bgcolor="#eeeeee" class="border_bl" colspan="3"><b>GenTHREADER Summary</b><br/></td></tr>
        <% if numberofrows > 30 %>
          <tr><td colspan="3"><b>Displaying only the top 30 results, full results can be found via the Downloads tab</b><br/></td></tr>
       <% end %>
      </table>
    <% elsif gen_control == 1
      name="pgen" %>
      <table>
        <tr><td bgcolor="#eeeeee" class="border_bl" colspan="3"><b>pGenTHREADER Summary</b><br/></td></tr>
        <% if numberofrows > 30 %>
          <tr><td colspan="3"><b>Displaying only the top 30 results, full results can be found via the Downloads tab</b><br/></td></tr>
       <% end %>
      </table>

    <% elsif gen_control == 2
      name="domgen" %>
      <table>
        <tr><td bgcolor="#eeeeee" class="border_bl" colspan="3"><b>pDomTHREADER Summary</b><br/></td></tr>
        <% if numberofrows > 30 %>
          <tr><td colspan="3"><b>Displaying only the top 30 results, full results can be found via the Downloads tab</b><br/></td></tr>
       <% end %>
      </table>
    <% end %>
    </div>

  <section class="annotation-group">
    <div class="model_buttons">
    <% if gen_control == 0
      name="gen" %>
      <a href="#" id="<%= name %>_model_button" class="form_input" title="Select structural hit to model">Build Model</a>
    <% elsif gen_control == 1
      name="mgen" %>
      <a href="#" id="<%= name %>_model_button" class="form_input" title="Select structural hit to model">Build Model</a>
    <% elsif gen_control == 2
      name="dgen" %>
      <a href="#" id="<%= name %>_model_button" class="form_input" title="Select structural hit to model">Build Model</a>
    <% end %>
    </div>
    <!-- ruler -->
    <div class="prot_scale">
      <div class="bot-row">
        <div class="bot-row-line">
          <div style="position: relative">
            <%
            count = 0
            while 1 do
              if count == 0 %>
                <span class="scale_numb_top" style="left: 1%;">0</span>
                <span class="scale_bar_top" title="0" style="left: 0%"></span>
                <% count+=50
              else
                diff = length-count
                if diff <=30 %>
                  <span class="scale_numb_top" style="left:100%"><%= length %></span>
                  <span class="scale_bar_top" title="<%= length %>" style="left:100%"></span>
                  <% break
                end
                percentage = (count.to_f/length.to_f)* 100 %>
                <span class="scale_numb_top" style="left:<%= percentage %><%= "%" %>"><%= count %></span>
                <span class="scale_bar_top" title="<%= count %>" style="left:<%= percentage %><%= "%" %>"></span>
                
                <% count+=50
              end
            end %>

          </div>
        </div>
      </div>

    </div>

    <!-- end ruler -->

    <div class="bot-row">

      <div class="bot-row-line-top"></div>
      <ol class="signatures">

        <%  line_count=0
        for line in results.data.split(/\n/)
          if line_count == 30
            break
          end
          line.chomp
          entries = line.split(/\s+/)
          if gen_control == 1 || gen_control == 0
            hit_id = entries[9]
          elsif gen_control ==2
            hit_id = entries[11]
          end
        %>

          <li id="<%= name %><%= line_count %>" class="signature entry-signatures">
            <div class="bot-row-signame"><%= hit_id %></div>
            <% aln_string = ""
           if gen_control == 0
                   @annotation_copy.each do |anno_state|
                     
                       if anno_state.status_class == 49
                         
                         if(anno_state.content_name =~ /.+_(\d+)\.aln/)
                             name_number = $1
                             if name_number =~ /^#{line_count.to_s}$/
                               aln_string = url_for(:controller => "bio_serf", :action => "getresultattached", :id => anno_state.id)

                             end
                         end
                     
                     end


                  end
           end

            if gen_control == 1
            @annotation_copy.each do |anno_state|
              if gen_control == 1
                       if anno_state.status_class == 73
                         if(anno_state.content_name =~ /.+_(\d+)\.aln/)
                             name_number = $1
                             if name_number =~ /^#{line_count.to_s}$/
                               aln_string = url_for(:controller => "bio_serf", :action => "getresultattached", :id => anno_state.id)

                             end
                         end
                     end
              end
            end
          end
            
          if gen_control == 2
        
                   @annotation_copy.each do |anno_state|
                     if anno_state.status_class == 75
                         if(anno_state.content_name =~ /.+_(\d+)\.aln/)
                             name_number = $1
                             if name_number =~ /^#{line_count.to_s}$/
                             aln_string = url_for(:controller => "bio_serf", :action => "getresultattached", :id => anno_state.id)
                             end
                          end
                     end
                   end

         end %>
            <div class="bot-row-signame" style="float:right"><div class="radio_model">
            <% if gen_control == 0
              name="gen" %>
                 <input type="radio" name="gen_selector" value="<%= aln_string %>" id="<%= hit_id %>" title="<%= hit_id %>" />
            <% elsif gen_control == 1
              name="mgen" %>
               <input type="radio" name="mgen_selector" value="<%= aln_string %>" id="<%= hit_id %>" title="<%= hit_id %>" />
            <% elsif gen_control == 2
              name="dgen" %>
               <input type="radio" name="dgen_selector" value="<%= aln_string %>" id="<%= hit_id %>" title="<%= hit_id %>" />
            <% end %>
           </div></div>
            
            <div class="bot-row-line"> <!-- THis is the grey background -->
              <div class="matches">
                <%
                colour = ""
                if entries[0] =~ /CERT|HIGH/
                  colour = "#00f000"
                end
                if entries[0] =~ /MEDIUM/
                  colour = "#ffaa00"
                end
                if entries[0] =~ /LOW/
                  colour = "#f00000"
                end
                if entries[0] =~ /GUESS/
                  colour = "#ff0000"
                end
                query_start = 0
                query_stop = 0
                target_start = 0
                target_stop = 0
                q_length = 0
                t_length = 0
                if gen_control == 0 || gen_control == 1
                  @job_results.each do |anno_state|
                    if anno_state.status_class == 49 || anno_state.status_class == 73
                      if(anno_state.content_name =~ /.+_(\d+)\.aln/)
                        name_number = $1
                        if name_number =~ /^#{line_count.to_s}$/
                          alignment_lines = anno_state.data.split(/\n/)
                          target_seq =alignment_lines[1].split(//)
                          query_seq = alignment_lines[3].split(//)
                          q_count = 0
                          t_count = 0
                          target_seq.each_with_index do |aa, index|
                            if aa !~ /-/
                              t_count+=1
                            end
                            if query_seq[index] !~ /-/
                              q_count+=1
                            end

                            if target_start == 0
                              if aa !~ /-/ && query_seq[index] !~ /-/
                                target_start=t_count
                              end
                            end

                            if aa !~ /-/ && query_seq[index] !~ /-/
                              target_stop = t_count
                              query_stop = q_count
                            end

                            if query_start == 0
                              if aa !~ /-/ && query_seq[index] !~ /-/
                                query_start=q_count
                              end
                            end

                          end
                        end
                      end
                    end
                  end
                  q_length = (query_stop-query_start)+1
                  t_length = (target_stop-target_start)+1
                elsif gen_control == 2

                  @job_results.each do |anno_state|
                    if anno_state.status_class == 75
                      if(anno_state.content_name =~ /.+_(\d+)\.aln/)
                        name_number = $1
                        if name_number =~ /^#{line_count.to_s}$/
                          alignment_lines = anno_state.data.split(/\n/)
                          target_seq =alignment_lines[1].split(//)
                          query_seq = alignment_lines[3].split(//)
                          q_count = 0
                          t_count = 0
                          target_seq.each_with_index do |aa, index|
                            if aa !~ /-/
                              t_count+=1
                            end
                            if query_seq[index] !~ /-/
                              q_count+=1
                            end

                            if target_start == 0
                              if aa !~ /-/ && query_seq[index] !~ /-/
                                target_start=t_count
                              end
                            end

                            if aa !~ /-/ && query_seq[index] !~ /-/
                              target_stop = t_count
                              query_stop = q_count
                            end

                            if query_start == 0
                              if aa !~ /-/ && query_seq[index] !~ /-/
                                query_start=q_count
                              end
                            end

                          end
                        end
                      end
                    end
                  end
                  q_length = (query_stop-query_start)+1
                  t_length = (target_stop-target_start)+1

                end
                alignment_start_pos = (query_start.to_f/length.to_f)*100
                alignment_stop_pos = ((q_length.to_f-1)/length.to_f)*100
              %>
                <span data-original-title="" id="<%= name %><%= line_count %>-region-1" class="match" style="left:<%= alignment_start_pos %><%= "%" %>; width:<%= alignment_stop_pos %><%= "%" %>; background-color:<%= colour %>">
                  <% if alignment_start_pos <= 2 %>
                    <span class="coords"><%= target_start %></span>
                  <% else %>
                    <span class="coords" style="left: -2em; top: -0.8em;"><%= target_start %></span>
                  <% end %>

                  <% if (alignment_start_pos+alignment_stop_pos) >= 98 %>
                    <span class="coords" style="float: right;"><%= target_stop %></span>
                  <% else %>
                    <span class="coords" style="float: right; top: -0.8em; right: -2em;"><%= target_stop %></span>
                  <% end %>
                </span><!-- this is the actual alignment doobery -->
                <script><!-- here's the annotation stuff -->
                  jQuery(function() {
                    applyAnnotation({
                      id:               	'<%= name %><%= line_count  %>-region-1',
  <% if gen_control == 2 %>
          title:            	'CATH Domain',
  <% else %>
          title:            	'PDB Chain',
  <% end %>
        region_start:   	'<%= query_start %>',
        region_end:     	'<%= query_stop %>',
        colour:             '<%= colour %>',
        data: [
          [ 'Query Align Coords:',    '<%= query_start %> - <%= query_stop %> (<%= q_length %> AA)' ],
          [ 'Target Align Coords:',   '<%= target_start %> - <%= target_stop%> (<%= t_length %> AA)' ],
          [ 'Query Length:',  '<%= length %>' ],
          [ 'Target Length:',  '<%= entries[7] %>' ],
          [ 'Match ID:',   '<%= hit_id %>' ],
        ],
      });
    });
                </script>
                <%  count = 0
                while 1 do
                  if count == 0 %>
                    <span class="grade" title="0" style="left: 0%"></span>
                    <% count+=50
                  else
                    diff = length-count
                    if diff <=30 %>
                      <span class="grade" title="<%= length %>" style="left:100%"></span>
                      <% break
                    end
                    percentage = (count.to_f/length.to_f)* 100
                  %>
                    <span class="grade" title="<%= count %>" style="left:<%= percentage %><%= "%" %>"></span>

                    <% count+=50
                  end
                end %>
              </div> <!-- close matches -->
            </div> <!-- close bot-row-line -->
          </li> <!-- close this annotation row -->
          <%
          line_count+=1
        end  %>
      </ol>

    </div> <!-- end bot-row -->



    <!-- ruler -->
    <div class="prot_scale">
      <div class="bot-row">
        <div class="bot-row-line">
          <div style="position: relative">
            <%
            count = 0
            while 1 do
              if count == 0 %>
                <span class="scale_bar" title="0" style="left: 0%"></span>
                <span class="scale_numb" style="left: 1%">0</span>
                <% count+=50
              else
                diff = length-count
                if diff <=30 %>
                  <span class="scale_bar" title="<%= length %>" style="left:100%"></span>
                  <span class="scale_numb" style="left:100%"><%= length %></span>
                  <% break
                end
                percentage = (count.to_f/length.to_f)* 100 %>
                <span class="scale_bar" title="<%= count %>" style="left:<%= percentage %><%= "%" %>"></span>
                <span class="scale_numb" style="left:<%= percentage %><%= "%" %>"><%= count %></span>
                <% count+=50
              end
            end %>

          </div>
        </div>
      </div>

    </div>
    <div class="model_buttons">
      <% if gen_control == 0
      name="gen" %>
      <a href="#" id="<%= name %>_model_button2" class="form_input" title="Select structural hit to model">Build Model</a>
    <% elsif gen_control == 1
      name="mgen" %>
      <a href="#" id="<%= name %>_model_button2" class="form_input" title="Select structural hit to model">Build Model</a>
    <% elsif gen_control == 2
      name="dgen" %>
      <a href="#" id="<%= name %>_model_button2" class="form_input" title="Select structural hit to model">Build Model</a>
    <% end %>
    </div>
</div>
