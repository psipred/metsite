<%#
# To change this template, choose Tools | Templates
# and open the template in the editor.
%>
<div style="background: <%= cycle(bgcolor,'#fff') %>; padding: 4px;">
  <% temp_data = log_result.data.gsub(/>>>\sAlignment\swith\s.{6,7}:\s/, "") %>
  
  <% alignment_segments = temp_data.split(/\n{3}/) %>
  <% if alignment_segments.length == 0 %>
        alignment_segments = temp_data
  <% end %>

  <a name="<%= log_result.content_name %>"></a>
  Alignment with <%= log_result.content_name %>:<br />
   <table>
  <%  alignment_segments.each_with_index do |segment, index| %>
    <% lines_temp = segment.split(/\n/) %>
    <% lines = [] %>
    <% lines_temp.each do |line| %>
      <% if line.length > 0 %>
        <%  lines.push(line) %>
      <% end %>
    <% end %>

    <% char_count = 0 %>
    <% alignment_characters = [] %>
    <% lines.each_with_index do |line, index2| %>
      <% line.chomp %>

      <% if(index2 == 0 || index2 == 6) %>

        <tr>
        <% characters = line.split("") %>
        <% characters.each do |character| %>
          <% char_count = characters.length %>
          <td class="alignment"><%=  character %></td>
        <% end %>
        </tr>
      <%  end %>

      <% if(index2 == 1 || index2 == 5) %>
        <tr>
        <% characters = line.split("") %>
        <% characters.each do |character| %>
          <% if character =~ /E/ %>
            <td class="strand"><%=  character %></td>
          <% elsif character =~ /H/ %>
            <td class="helix"><%=  character %></td>
          <% else %>
            <td class="alignment"><%=  character %></td>
          <% end %>
        <% end %>
        </tr>
        
      <% end %>

      <% if(index2 == 2) %>
        <% alignment_characters = line.split("") %>
      <%  end %>

      <% if(index2 == 4) %>
        <% characters = line.split("") %>
        
        <%  association = {}
        characters.each_with_index do |character, index3|
          if index3 < 9
            next
          end
       
          if (character =~ /C|T|S|D|N|Q|E|K|H|R|Y|W/i && alignment_characters[index3] =~ /C|T|S|D|N|Q|E|K|H|R|Y|W/i)
            association["#{index3}"] = "match"
          end

          if (character =~ /V|C|P|D|N|G|A|T|S/i && alignment_characters[index3] =~ /V|C|P|D|N|G|A|T|S/i)
            association["#{index3}"] = "match"
          end

          if (character =~ /M|I|V|L|C|G|A|K|H|Y|W|F/i && alignment_characters[index3] =~ /M|I|V|L|C|G|A|K|H|Y|W|F/i)
            association["#{index3}"] = "match"
          end


          if character == alignment_characters[index3]
            association["#{index3}"] = "identical"
          end

        end %>

        <tr>
        <% alignment_characters.each_with_index do |character, index3| %>
          <% if association["#{index3}"] =~ /identical/ %>
            <td class="identical"><%=  character %></td>
          <% elsif association["#{index3}"] =~ /match/ %>
            <td class="similar"><%=  character %></td>
          <% else %>
            <td class="alignment"><%=  character %></td>
          <% end %>
        <% end %>
        </tr>
      
      <tr>
        <% characters.each_with_index do |character, index3| %>
          <% if association["#{index3}"] =~ /identical/ %>
            <td class="identical"><%=  character %></td>
          <% elsif association["#{index3}"] =~ /match/ %>
            <td class="similar"><%=  character %></td>
          <% else %>
            <td class="alignment"><%=  character %></td>
          <% end %>
        <% end %>
        </tr>
        

      <%  end %>
    <% end %>
    <tr><td colspan="<%= char_count %>"><hr class="row_separator" /></td></tr>
  <% end %>
  <tr>
  </table>
</div>
