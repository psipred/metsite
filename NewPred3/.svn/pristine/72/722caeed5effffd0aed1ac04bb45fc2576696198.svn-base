
<% hostname = self.request.host

  if(seq.to_s.count('>') > 0)
    seq_count=0
    seqs=[]
    seq.to_s.gsub!(/\r/,"")
    seq.to_s.gsub!(/-/,"")
    lines = seq.to_s.split("\n")
    lines.each do |line|
      if line =~ /^>/
        seq_count+=1
        seqs[seq_count]=""
      else
        line.gsub!(/\s+/, "")
        seqs[seq_count]= seqs[seq_count] + line
        #seqs[seq_count]= seqs[seq_count] + line.gsub!(/\s+/, "")
      end
    end
      seq=seqs[1].split("")
  else
    seq.to_s.gsub!(/-/,"")
  end
%>
<% length = seq.length() %>
<br />
<div class="span13">

<script>

$(document).ready(function() {
 
    $("#slider").slider({
        range: true,
        min: 1,
        max: <%= length %>,
        step: 1,
        values: [1, <%= length %>],
        slide: function(event, ui) {
          if(ui.values[1] - ui.values[0] < 30){
               false;
          }
          else
          {
            for (var i = 0; i < ui.values.length; ++i) {
                $("input.sliderValue[data-index=" + i + "]").val(ui.values[i]);
            }
          }
        }
    });

    $("input.sliderValue").change(function() {
        var $this = $(this);
        if($("input.sliderValue[data-index=1]").val() - $("input.sliderValue[data-index=0]").val() < 30){
          false;
        }
        else
        {
          $("#slider").slider("values", $this.data("index"), $this.val());
        }
    });

});

$(function() {
        // run the currently selected effect
        function runEffect() {
            // get effect type from
            var selectedEffect = "blind";

            // most effect types need no options passed by default
            var options = {};
            // some effects have required parameters
            
            // run the effect
            $( "#select_effect" ).toggle( selectedEffect, options, 500 );
        };

        // set effect from select menu value
        $( "#select_button" ).click(function() {
            runEffect();
            return false;
        });

        // set effect from select menu value
        $( "#submit_button" ).click(function() {
            sequence="<%= seq %>"
            email="<%= @job.address %>"
            subject="<%= @job.name %>"
            model_key = 0
            start = $("input.sliderValue[data-index=0]").val()
            start = start-1
            stop = $("input.sliderValue[data-index=1]").val()
            length = stop-start
            segment = sequence.substr(start,length)

            psipred = 0
            if($('#program_psipred').is(":checked"))
            {
              psipred = 1
            }
            disopred = 0
            if($('#program_disopred').is(":checked"))
            {
              disopred = 1
            }
            mgenthreader =0
            if($('#program_mgenthreader').is(":checked"))
            {
              mgenthreader = 1
            }
            svmmemsat = 0
            if($('#program_svmmemsat').is(":checked"))
            {
              svmmemsat = 1
            }
            bioserf = 0
            if($('#program_bioserf').is(":checked"))
            {
              bioserf = 1
              model_key=1
            }
            dompred = 0
            if($('#program_dompred').is(":checked"))
            {
              dompred = 1
            }
            ffpred = 0
            if($('#program_ffpred').is(":checked"))
            {
              ffpred = 1
            }
            genthreader = 0
            if($('#program_genthreader').is(":checked"))
            {
              ffpred = 1
            }
            mempack = 0
            if($('#program_mempack').is(":checked"))
            {
              mempack = 1
            }
            domthreader = 0
            if($('#program_domthreader').is(":checked"))
            {
              domthreader = 1
            }
            domserf = 0
            if($('#program_domserf').is(":checked"))
            {
              domserf = 1
            }
            
            if( psipred == 0 && disopred == 0 && mgenthreader == 0 && svmmemsat == 0 && bioserf == 0 && dompred == 0 && ffpred == 0 && genthreader == 0 && mempack == 0 && domthreader == 0 && domserf == 0)
            {
              $( "#selected" ).dialog( "open" );
              return false;
            }

            if( length < 30)
            {
              $( "#short" ).dialog( "open" );
            }
            else if (length > 1500 )
            {
              $( "#long" ).dialog( "open" );
            }
            else
            {
            window.open("http://<%= hostname%>/<%= h(@service_name) %>/submit/?"+
                        "program_psipred="+psipred+
                        "&program_disopred="+disopred+
                        "&program_mgenthreader="+mgenthreader+
                        "&program_svmmemsat="+svmmemsat+
                        "&program_bioserf="+bioserf+
                        "&program_dompred="+dompred+
                        "&program_ffpred="+ffpred+
                        "&program_genthreader="+genthreader+
                        "&program_mempack="+mempack+
                        "&program_domthreader="+domthreader+
                        "&program_domserf="+domserf+
                        "&subject="+subject+
                        "&email="+email+
                        "&mod="+model_key+
                        "&msa_control=all"+
                        "&sequence="+segment);
            }
            return false;
            
        });
        
        $( "#select_effect" ).hide();
    });

</script>

<table>
    <tr><td bgcolor="#eeeeee" class="border_bl" colspan="3"><b>Sequence Resubmission</b><br/></td></tr>
    <tr><td>Start</td><td></td><td>Stop</td></tr>
  <tr>
    <td><div id="selectorTooltip"><input type="text" class="sliderValue" data-index="0" value="1" size="3" title="Input the start position for the subsequence" /></div></td>
    <td align="center"><div id="generalTooltip"><div id="slider" style="width: 800px" title="Use the slider to select a subsequence of your query sequence"> </div></div></td>
    <td><div id="selectorTooltip"><input type="text" class="sliderValue" data-index="1" value="<%= length %>" size="3" title="Input the stop position for the subsequence" /></div></td>
  </tr>
</table><br /><br />

<div class="select_buttons">
  <a href="#" id="select_button" class="form_input" title="Select which analyses you wish to perform">Select Methods</a>
</div>
<div class="toggler">
    <div id="select_effect" class="ui-widget-content ui-corner-all">
<table>
    <tr><td><input class="program_psipred2" id="program_psipred" name="program_psipred" type="checkbox" value="1" />PSIPRED v3.3 (Predict Secondary Structure)</td>
    <td><input class="program_disopred2" id="program_disopred" name="program_disopred" type="checkbox" value="1" />DISOPRED3 & DISOPRED2 (Disorder Prediction)</td></tr>
    <tr><td><input class="program_mgenthreader2" id="program_mgenthreader" name="program_mgenthreader" type="checkbox" value="1" />pGenTHREADER (Profile Based Fold Recognition)</td>
    <td><input class="program_svmmemsat2" id="program_svmmemsat" name="program_svmmemsat" type="checkbox" value="1" />MEMSAT3 & MEMSAT-SVM (Membrane Helix Topology Prediction)</td></tr>
    <tr><td>&nbsp;</td></tr>
    <tr><td><input class="program_bioserf2" id="program_bioserf" name="program_bioserf" type="checkbox" value="1" />BioSerf v2.0 (Automated Homology Modelling)</td>
    <td><input class="program_dompred2" id="program_dompred" name="program_dompred" type="checkbox" value="1" />DomPred (Protein Domain Prediction)</td></tr>
    <tr><td><input class="program_ffpred2" id="program_ffpred" name="program_ffpred" type="checkbox" value="1" />FFPred v2.0 (Eukaryotic Function Prediction)</td>
    <td><input class="program_genthreader2" id="program_genthreader" name="program_genthreader" type="checkbox" value="1" />GenTHREADER (Rapid Fold Recognition)</td></tr>
    <tr><td><input class="program_mempack2" id="program_mempack" name="program_mempack" type="checkbox" value="1" />MEMPACK (SVM Prediction of TM Topology and Helix Packing)</td>
    <td><input class="program_domthreader2" id="program_domthreader" name="program_domthreader" type="checkbox" value="1" />pDomTHREADER (Fold Domain Recognition)</td></tr>
    <tr><td><input class="program_domserf2" id="program_domserf" name="program_domserf" type="checkbox" value="1" />DomSerf v2.0 (Automated Domain Modelling by Homology)</td>
    <td></td></tr>

</table>
      <div class="resubmit_buttons">
   <a href="#" id="submit_button" class="form_input" title="Submit new sequence">Resubmit</a>
   </div>
    </div>

</div>
</div>

<div id="short" title="Too Short">
    <p>The sequence segment you've selected is too short to process. The sequence must be greater than 30 residues</p>
</div>

<div id="long" title="Too long">
    <p>The sequence segment you've selected is too long to process (>1,500 residues). Please return to the <a href="http://bioinf.cs.ucl.ac.uk/psipred/">PSIPRED main page</a> and try using DomPred to find shorter domains</p>
</div>

<div id="selected" title="No Selection">
    <p>You have not selected any analyses</p>
</div>